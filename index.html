<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Management System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        
        /* Home Page */
        .home-page { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .home-content { text-align: center; color: white; }
        .home-content h1 { font-size: 4em; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .home-content p { font-size: 1.5em; margin-bottom: 40px; opacity: 0.9; }
        .home-btn { background: white; color: #667eea; padding: 20px 50px; font-size: 1.5em; border: none; border-radius: 50px; cursor: pointer; font-weight: 700; box-shadow: 0 10px 30px rgba(0,0,0,0.3); transition: transform 0.3s; margin: 10px; }
        .home-btn:hover { transform: translateY(-5px); }
        
        /* Catalog */
        .catalog-page { display: none; padding: 40px 20px; }
        .catalog-container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; padding: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .catalog-header { text-align: center; margin-bottom: 40px; }
        .catalog-header h1 { color: #667eea; font-size: 3em; margin-bottom: 10px; }
        .catalog-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; margin-top: 30px; }
        .product-catalog-card { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 15px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: transform 0.3s; border-left: 5px solid #667eea; }
        .product-catalog-card:hover { transform: translateY(-5px); }
        .product-catalog-name { font-size: 1.5em; font-weight: 700; color: #212529; margin-bottom: 15px; }
        .product-catalog-price { font-size: 2em; color: #667eea; font-weight: 700; margin: 15px 0; }
        .product-catalog-stock { display: inline-block; background: #d4edda; color: #155724; padding: 5px 15px; border-radius: 20px; font-size: 0.9em; font-weight: 600; margin-top: 10px; }
        .product-catalog-stock.low { background: #f8d7da; color: #721c24; }
        
        /* Login */
        .login-container { display: none; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .login-box { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 400px; width: 100%; }
        .login-header { text-align: center; margin-bottom: 30px; }
        .login-header h1 { font-size: 2em; color: #667eea; margin-bottom: 10px; }
        .login-icon { font-size: 4em; margin-bottom: 20px; }
        
        /* App */
        .app-container { display: none; }
        .container { max-width: 1400px; margin: 20px auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; position: relative; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .user-info { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 20px; font-size: 14px; display: flex; align-items: center; gap: 10px; }
        .sync-status { position: absolute; top: 20px; left: 20px; background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 20px; font-size: 14px; display: flex; align-items: center; gap: 10px; }
        .sync-indicator { width: 10px; height: 10px; border-radius: 50%; background: #28a745; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .user-role-badge { background: rgba(255,255,255,0.3); padding: 3px 10px; border-radius: 12px; font-size: 11px; text-transform: uppercase; }
        .logout-btn { background: rgba(255,255,255,0.3); padding: 5px 15px; border-radius: 15px; cursor: pointer; transition: background 0.3s; font-size: 12px; }
        .logout-btn:hover { background: rgba(255,255,255,0.5); }
        
        .tabs { display: flex; background: #f8f9fa; border-bottom: 2px solid #dee2e6; overflow-x: auto; }
        .tab { flex: 1; min-width: 120px; padding: 20px 10px; text-align: center; cursor: pointer; font-weight: 600; color: #495057; transition: all 0.3s; border-bottom: 3px solid transparent; white-space: nowrap; }
        .tab:hover { background: #e9ecef; }
        .tab.active { background: white; color: #667eea; border-bottom-color: #667eea; }
        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; }
        
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #495057; }
        input[type="text"], input[type="password"], input[type="number"], input[type="date"], select, textarea { width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 16px; transition: border-color 0.3s; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; }
        button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 30px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s; }
        button:hover { transform: translateY(-2px); }
        .btn-secondary { background: #6c757d; }
        .btn-success { background: #28a745; }
        .btn-danger { background: #dc3545; }
        .btn-info { background: #17a2b8; }
        
        .item-card, .product-card, .sale-card, .expense-card { background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #667eea; }
        .expense-card { border-left-color: #dc3545; }
        .item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .item-name { font-size: 1.2em; font-weight: 600; color: #212529; }
        .item-price { font-size: 1.3em; color: #667eea; font-weight: 700; }
        .item-actions button { margin-right: 10px; padding: 8px 16px; font-size: 14px; }
        .empty-state { text-align: center; padding: 60px 20px; color: #6c757d; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; text-align: center; }
        .stat-card.success { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
        .stat-card.danger { background: linear-gradient(135deg, #dc3545 0%, #f86c6b 100%); }
        .stat-card.warning { background: linear-gradient(135deg, #ffc107 0%, #ffb300 100%); }
        .stat-card.info { background: linear-gradient(135deg, #17a2b8 0%, #00bcd4 100%); }
        .stat-value { font-size: 2.5em; font-weight: 700; margin-bottom: 10px; }
        .stat-label { font-size: 1em; opacity: 0.9; }
        
        .two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .three-column { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        .info-box { background: #d1ecf1; border-left: 4px solid #17a2b8; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .info-box h4 { color: #0c5460; margin-bottom: 8px; }
        .info-box p { color: #0c5460; margin: 5px 0; }
        .search-box { margin-bottom: 20px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin: 30px 0 20px; }
        .ingredient-row { display: flex; gap: 15px; margin-bottom: 15px; align-items: end; }
        .ingredient-row > div { flex: 1; }
        .ingredient-row button { padding: 12px 20px; }
        
        .calculation-box { background: #e7f3ff; padding: 20px; border-radius: 12px; margin-top: 20px; border-left: 4px solid #0066cc; }
        .calculation-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 16px; }
        .calculation-row.total { font-size: 20px; font-weight: 700; color: #0066cc; padding-top: 15px; border-top: 2px solid #0066cc; margin-top: 15px; }
        .earnings-badge { display: inline-block; padding: 5px 12px; border-radius: 15px; font-size: 12px; font-weight: 600; margin-left: 10px; }
        .earnings-badge.own { background: #d4edda; color: #155724; }
        .earnings-badge.commission { background: #fff3cd; color: #856404; }
        
        .password-toggle { position: relative; }
        .password-toggle-btn { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #6c757d; cursor: pointer; padding: 5px; width: auto; }
        .error-message { background: #f8d7da; color: #721c24; padding: 12px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #dc3545; }
        .config-banner { background: #fff3cd; color: #856404; padding: 15px 30px; text-align: center; border-bottom: 2px solid #ffc107; }
        .config-banner.success { background: #d4edda; color: #155724; border-bottom-color: #28a745; }
        .config-banner a { color: #0066cc; text-decoration: underline; cursor: pointer; }
        
        .date-badge { display: inline-block; background: #6c757d; color: white; padding: 5px 12px; border-radius: 20px; font-size: 12px; margin-top: 5px; }
        .filter-section { background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .table-container { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6; }
        th { background: #f8f9fa; font-weight: 600; color: #495057; }
        tr:hover { background: #f8f9fa; }
        .profit-card { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; }
        .profit-value { font-size: 3em; font-weight: 700; margin: 15px 0; }
        .stock-status { font-size: 14px; color: #6c757d; margin-top: 5px; }
        .stock-low { color: #dc3545; font-weight: 600; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; overflow-y: auto; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-content h2 { margin-bottom: 20px; }
        .setup-step { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #667eea; }
        .setup-step h4 { margin-bottom: 10px; color: #667eea; }
        
        @media (max-width: 768px) {
            .two-column, .three-column { grid-template-columns: 1fr; }
            .user-info, .sync-status { position: static; margin-top: 15px; justify-content: center; }
            .home-content h1 { font-size: 2.5em; }
            .product-grid { grid-template-columns: 1fr; }
        }
        
        @media print {
            .header, .tabs, button, .search-box, .item-actions { display: none !important; }
            .container { box-shadow: none !important; margin: 0 !important; }
        }
    </style>
</head>
<body>
    <!-- Firebase Modal -->
    <div id="setup-modal" class="modal">
        <div class="modal-content">
            <h2>üîß Firebase Setup</h2>
            <p style="margin-bottom: 20px;">Connect to sync data across devices</p>
            
            <div class="setup-step">
                <h4>Step 1: Create Firebase Project</h4>
                <p>Go to <a href="https://console.firebase.google.com" target="_blank">Firebase Console</a> ‚Üí Add Project</p>
            </div>

            <div class="setup-step">
                <h4>Step 2: Enable Firestore</h4>
                <p>Firestore Database ‚Üí Create ‚Üí Test mode ‚Üí Enable</p>
            </div>

            <div class="setup-step">
                <h4>Step 3: Enter Config</h4>
                <div class="form-group">
                    <label>API Key *</label>
                    <input type="text" id="config-apiKey" placeholder="AIzaSy...">
                </div>
                <div class="form-group">
                    <label>Auth Domain *</label>
                    <input type="text" id="config-authDomain" placeholder="project.firebaseapp.com">
                </div>
                <div class="form-group">
                    <label>Project ID *</label>
                    <input type="text" id="config-projectId" placeholder="project-id">
                </div>
                <div class="form-group">
                    <label>Storage Bucket *</label>
                    <input type="text" id="config-storageBucket" placeholder="project.appspot.com">
                </div>
                <div class="form-group">
                    <label>Messaging Sender ID *</label>
                    <input type="text" id="config-messagingSenderId" placeholder="123456789">
                </div>
                <div class="form-group">
                    <label>App ID *</label>
                    <input type="text" id="config-appId" placeholder="1:123:web:abc">
                </div>
            </div>

            <button onclick="saveFirebaseConfig()" class="btn-success">üíæ Save & Connect</button>
            <button onclick="closeSetupModal()" class="btn-secondary" style="margin-left: 10px;">Skip</button>
        </div>
    </div>

    <!-- Home -->
    <div id="home-page" class="home-page">
        <div class="home-content">
            <h1>üíº Business Manager</h1>
            <p>Complete Inventory & Sales System</p>
            <button class="home-btn" onclick="showCatalog()">View Products</button>
            <br>
            <button class="home-btn" onclick="showLogin()" style="background: rgba(255,255,255,0.2); color: white;">üîê Staff Login</button>
        </div>
    </div>

    <!-- Catalog -->
    <div id="catalog-page" class="catalog-page">
        <div class="catalog-container">
            <div class="catalog-header">
                <h1>üì¶ Product Catalog</h1>
                <p style="color: #6c757d;">Available products and prices</p>
            </div>
            <div class="catalog-actions">
                <button onclick="showHome()" class="btn-secondary">‚Üê Back</button>
                <div class="search-box" style="flex: 1; max-width: 400px; margin: 0 20px;">
                    <input type="text" id="catalog-search" placeholder="üîç Search..." onkeyup="filterCatalog()">
                </div>
                <button onclick="window.print()" class="btn-info">üñ®Ô∏è Print</button>
            </div>
            <div id="product-catalog-grid" class="product-grid"></div>
        </div>
    </div>

    <!-- Login -->
    <div id="login-page" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <div class="login-icon">üîê</div>
                <h1>Staff Login</h1>
            </div>
            <div id="login-error"></div>
            <form id="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="login-username" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <div class="password-toggle">
                        <input type="password" id="login-password" required>
                        <button type="button" class="password-toggle-btn" onclick="togglePassword()">üëÅÔ∏è</button>
                    </div>
                </div>
                <button type="submit">Login</button>
                <button type="button" class="btn-secondary" onclick="showHome()" style="margin-top: 10px;">Cancel</button>
            </form>
            <div style="background: #d1ecf1; border-radius: 8px; padding: 15px; margin-top: 20px; font-size: 14px;">
                <p style="color: #0c5460;"><strong>Default:</strong> admin/admin123 or user/user123</p>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div id="app-container" class="app-container">
        <div class="container">
            <div class="header">
                <div class="sync-status">
                    <div class="sync-indicator"></div>
                    <span id="sync-status-text">Local</span>
                </div>
                <h1>üíº Business Management</h1>
                <p>Multi-User System</p>
                <div class="user-info">
                    <span id="current-user-display">üë§ User</span>
                    <span class="user-role-badge" id="user-role-badge">User</span>
                    <span class="logout-btn" onclick="handleLogout()">Logout</span>
                </div>
            </div>

            <div id="config-banner" class="config-banner">
                ‚ö†Ô∏è Firebase not configured. <a onclick="openSetupModal()">Setup cloud sync</a>
            </div>

            <!-- Dynamic Tabs (will be populated based on role) -->
            <div id="tabs-container" class="tabs"></div>

            <!-- ADMIN TABS -->
            <div id="dashboard-tab" class="tab-content">
                <h2>Dashboard</h2>
                <div class="stats-grid" id="dashboard-stats"></div>
                <h3 style="margin-top: 30px;">Recent Activity</h3>
                <div id="recent-activity"></div>
            </div>

            <div id="items-tab" class="tab-content">
                <h2>Item Master List (Admin Only)</h2>
                <p style="color: #6c757d; margin-bottom: 20px;">Define your items with selling prices (price per unit you charge customers)</p>
                
                <form id="item-form" onsubmit="addItem(event)">
                    <div class="three-column">
                        <div class="form-group">
                            <label>Item Name *</label>
                            <input type="text" id="item-name" required>
                        </div>
                        <div class="form-group">
                            <label>Price (‚Ç±) *</label>
                            <input type="number" id="item-price" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Unit *</label>
                            <input type="text" id="item-unit" required>
                        </div>
                    </div>
                    <div class="three-column">
                        <div class="form-group">
                            <label>Category</label>
                            <input type="text" id="item-category">
                        </div>
                        <div class="form-group">
                            <label>SKU (Auto)</label>
                            <input type="text" id="item-sku" readonly style="background: #f0f0f0;">
                        </div>
                        <div class="form-group">
                            <label>Quantity</label>
                            <input type="number" id="item-quantity" step="0.01">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Specifications</label>
                        <textarea id="item-specs" rows="3"></textarea>
                    </div>
                    <button type="submit">Add Item</button>
                </form>
                <div class="section-header"><h2>Items</h2></div>
                <div class="search-box">
                    <input type="text" id="item-search" placeholder="üîç Search..." onkeyup="filterItems()">
                </div>
                <div id="items-list"></div>
            </div>

            <div id="expenses-tab" class="tab-content">
                <h2>Record Expenses</h2>
                <p style="color: #6c757d; margin-bottom: 20px;">Track actual purchases and costs of items</p>
                
                <form id="expense-form" onsubmit="addExpense(event)">
                    <div class="three-column">
                        <div class="form-group">
                            <label>Date *</label>
                            <input type="date" id="expense-date" required>
                        </div>
                        <div class="form-group">
                            <label>Select Item *</label>
                            <select id="expense-item" required>
                                <option value="">Choose an item...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Quantity Purchased *</label>
                            <input type="number" id="expense-quantity" step="0.01" required>
                        </div>
                    </div>
                    <div class="three-column">
                        <div class="form-group">
                            <label>Cost Paid (‚Ç±) *</label>
                            <input type="number" id="expense-cost" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Supplier</label>
                            <input type="text" id="expense-supplier">
                        </div>
                        <div class="form-group">
                            <label>Notes</label>
                            <input type="text" id="expense-notes">
                        </div>
                    </div>
                    <button type="submit">Record Expense</button>
                </form>

                <div class="section-header">
                    <h2>Expense History</h2>
                    <select id="expense-filter" onchange="filterExpenses()">
                        <option value="all">All</option>
                        <option value="today">Today</option>
                        <option value="week">Week</option>
                        <option value="month">Month</option>
                    </select>
                </div>
                <div id="expenses-list"></div>
            </div>

            <!-- USER & ADMIN TABS -->
            <div id="products-tab" class="tab-content">
                <h2>Create Product</h2>
                <form id="product-form" onsubmit="addProduct(event)">
                    <div class="two-column">
                        <div class="form-group">
                            <label>Product Name *</label>
                            <input type="text" id="product-name" required>
                        </div>
                        <div class="form-group">
                            <label>SKU (Auto)</label>
                            <input type="text" id="product-sku" readonly style="background: #f0f0f0;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="product-description" rows="3"></textarea>
                    </div>
                    <h3 style="margin: 30px 0 20px;">Materials</h3>
                    <div id="ingredients-container"></div>
                    <button type="button" class="btn-secondary" onclick="addIngredientRow()">+ Add Material</button>
                    <div class="two-column" style="margin-top: 30px;">
                        <div class="form-group">
                            <label>Labor (‚Ç±) *</label>
                            <input type="number" id="product-labor" step="0.01" value="0" required>
                        </div>
                        <div class="form-group">
                            <label>Markup % *</label>
                            <input type="number" id="product-markup" step="0.01" value="30" required>
                        </div>
                    </div>
                    <button type="submit">Save Product</button>
                </form>
                <div class="section-header"><h2>Products</h2></div>
                <div id="products-list"></div>
            </div>

            <div id="sales-tab" class="tab-content">
                <h2>Record Sale</h2>
                <form id="sale-form" onsubmit="recordSale(event)">
                    <div class="three-column">
                        <div class="form-group">
                            <label>Date *</label>
                            <input type="date" id="sale-date" required>
                        </div>
                        <div class="form-group">
                            <label>Product *</label>
                            <select id="sale-product" required onchange="updateSalePrice()">
                                <option value="">Choose...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Quantity *</label>
                            <input type="number" id="sale-quantity" step="1" value="1" required min="1">
                        </div>
                    </div>
                    <div class="three-column">
                        <div class="form-group">
                            <label>Price (‚Ç±) *</label>
                            <input type="number" id="sale-price" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Customer</label>
                            <input type="text" id="sale-customer">
                        </div>
                        <div class="form-group">
                            <label>Payment</label>
                            <select id="sale-payment">
                                <option>Cash</option>
                                <option>GCash</option>
                                <option>Bank</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit">Record Sale</button>
                </form>
                <div class="section-header">
                    <h2>Sales</h2>
                    <select id="sales-filter" onchange="filterSales()">
                        <option value="all">All</option>
                        <option value="today">Today</option>
                        <option value="week">Week</option>
                        <option value="month">Month</option>
                    </select>
                </div>
                <div id="sales-list"></div>
            </div>

            <div id="earnings-tab" class="tab-content">
                <h2>üí∞ My Earnings</h2>
                <div class="info-box">
                    <h4>How it works:</h4>
                    <p><strong>Your Products:</strong> Earn full labor cost</p>
                    <p><strong>Other's Products:</strong> Earn 10% commission</p>
                </div>
                <div class="stats-grid" id="earnings-stats"></div>
                <div class="section-header">
                    <h2>Breakdown</h2>
                    <select id="earnings-filter" onchange="calculateEarnings()">
                        <option value="all">All</option>
                        <option value="today">Today</option>
                        <option value="week">Week</option>
                        <option value="month">Month</option>
                    </select>
                </div>
                <div id="earnings-details"></div>
                <button onclick="window.print()" class="btn-info" style="margin-top: 20px;">üñ®Ô∏è Print Report</button>
            </div>

            <!-- ADMIN ONLY TABS -->
            <div id="profit-tab" class="tab-content">
                <h2>Profit Analysis</h2>
                <div class="filter-section">
                    <label>Filter Period:</label>
                    <select id="profit-filter" onchange="calculateProfit()">
                        <option value="all">All</option>
                        <option value="today">Today</option>
                        <option value="week">Week</option>
                        <option value="month">Month</option>
                    </select>
                </div>
                <div id="profit-summary"></div>
                <div id="profit-details"></div>
            </div>

            <div id="labor-tab" class="tab-content">
                <h2>Labor Analysis</h2>
                <div class="filter-section">
                    <label>Filter Period:</label>
                    <select id="labor-filter" onchange="calculateLabor()">
                        <option value="all">All</option>
                        <option value="today">Today</option>
                        <option value="week">Week</option>
                        <option value="month">Month</option>
                    </select>
                </div>
                <div id="labor-summary"></div>
                <div id="labor-details"></div>
            </div>

            <div id="inventory-tab" class="tab-content">
                <h2>üìä Inventory</h2>
                <div id="inventory-list"></div>
            </div>

            <div id="reports-tab" class="tab-content">
                <h2>Business Reports</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="report-total-items">0</div>
                        <div class="stat-label">Total Items</div>
                    </div>
                    <div class="stat-card info">
                        <div class="stat-value" id="report-total-products">0</div>
                        <div class="stat-label">Total Products</div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-value" id="report-total-expenses">‚Ç±0</div>
                        <div class="stat-label">Total Expenses</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-value" id="report-total-sales">‚Ç±0</div>
                        <div class="stat-label">Total Sales</div>
                    </div>
                </div>
                <h3>Quick Actions</h3>
                <div style="margin-top: 20px;">
                    <button onclick="exportData()">üì• Export Data</button>
                    <button class="btn-secondary" onclick="document.getElementById('import-file').click()" style="margin-left: 10px;">üì§ Import Data</button>
                    <button class="btn-info" onclick="window.print()" style="margin-left: 10px;">üñ®Ô∏è Print Report</button>
                    <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importData(event)">
                </div>
            </div>

            <div id="settings-tab" class="tab-content">
                <h2>Settings</h2>
                <div class="info-box">
                    <h4>üë§ Current User</h4>
                    <p><strong>Username:</strong> <span id="settings-username">-</span></p>
                    <p><strong>Role:</strong> <span id="settings-role">-</span></p>
                </div>
                <div class="info-box">
                    <h4>üîÑ Sync</h4>
                    <p id="settings-sync-status">Not connected</p>
                </div>
                <h3>Firebase</h3>
                <button onclick="openSetupModal()" class="btn-info">Configure</button>
                <button onclick="testConnection()" class="btn-secondary" style="margin-left: 10px;">Test</button>
                <button onclick="clearFirebaseConfig()" class="btn-danger" style="margin-left: 10px;">Clear</button>
                <h3 style="margin-top: 30px;">Change Password</h3>
                <form id="change-password-form" onsubmit="changePassword(event)">
                    <div class="two-column">
                        <div class="form-group">
                            <label>Current *</label>
                            <input type="password" id="current-password" required>
                        </div>
                        <div class="form-group">
                            <label>New *</label>
                            <input type="password" id="new-password" required minlength="6">
                        </div>
                    </div>
                    <button type="submit">Change</button>
                </form>
                <div id="admin-section" style="display: none;">
                    <h3 style="margin-top: 40px;">Admin: Users</h3>
                    <form id="add-user-form" onsubmit="addUser(event)" style="margin-top: 20px;">
                        <div class="three-column">
                            <div class="form-group">
                                <label>Username *</label>
                                <input type="text" id="new-username" required>
                            </div>
                            <div class="form-group">
                                <label>Password *</label>
                                <input type="password" id="new-user-password" required minlength="6">
                            </div>
                            <div class="form-group">
                                <label>Role *</label>
                                <select id="new-user-role" required>
                                    <option value="user">User</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn-success">Add User</button>
                    </form>
                    <div id="users-list" style="margin-top: 20px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        let db = null;
        let firebaseInitialized = false;
        let currentUser = null;
        let unsubscribeItems = null;
        let unsubscribeProducts = null;
        let unsubscribeSales = null;
        let unsubscribeExpenses = null;
        
        function initializeDefaultUsers() {
            const storedUsers = localStorage.getItem('users');
            if (!storedUsers) {
                const defaultUsers = [
                    {username: 'admin', password: 'admin123', role: 'admin', createdAt: new Date().toISOString()},
                    {username: 'user', password: 'user123', role: 'user', createdAt: new Date().toISOString()}
                ];
                localStorage.setItem('users', JSON.stringify(defaultUsers));
                return defaultUsers;
            }
            return JSON.parse(storedUsers);
        }
        
        let users = initializeDefaultUsers();
        let items = [];
        let products = [];
        let sales = [];
        let expenses = [];

        document.addEventListener('DOMContentLoaded', () => {
            users = initializeDefaultUsers();
            loadLocalData();
            loadFirebaseConfig();
            checkSession();
            document.getElementById('sale-date').valueAsDate = new Date();
            document.getElementById('expense-date').valueAsDate = new Date();
        });

        function showHome() {
            document.getElementById('home-page').style.display = 'flex';
            document.getElementById('catalog-page').style.display = 'none';
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('app-container').style.display = 'none';
        }
        
        function showCatalog() {
            document.getElementById('home-page').style.display = 'none';
            document.getElementById('catalog-page').style.display = 'block';
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('app-container').style.display = 'none';
            loadLocalData();
            renderCatalog();
        }
        
        function showLogin() {
            document.getElementById('home-page').style.display = 'none';
            document.getElementById('catalog-page').style.display = 'none';
            document.getElementById('login-page').style.display = 'flex';
            document.getElementById('app-container').style.display = 'none';
        }
        
        function showApp() {
            document.getElementById('home-page').style.display = 'none';
            document.getElementById('catalog-page').style.display = 'none';
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            
            document.getElementById('current-user-display').textContent = 'üë§ ' + currentUser.username;
            document.getElementById('user-role-badge').textContent = currentUser.role;
            document.getElementById('settings-username').textContent = currentUser.username;
            document.getElementById('settings-role').textContent = currentUser.role;
            
            // Setup tabs based on role
            setupTabs();
            
            if (currentUser.role === 'admin') {
                document.getElementById('admin-section').style.display = 'block';
                renderUsersList();
            } else {
                document.getElementById('admin-section').style.display = 'none';
            }
            
            loadLocalData();
            
            if (firebaseInitialized) {
                setupRealtimeSync();
            }
            
            updateSKUFields();
            renderAll();
            updateDashboard();
            calculateEarnings();
            calculateProfit();
            calculateLabor();
            updateInventory();
            updateReports();
        }

        function setupTabs() {
            const tabsContainer = document.getElementById('tabs-container');
            
            if (currentUser.role === 'admin') {
                // Admin sees all tabs
                tabsContainer.innerHTML = `
                    <div class="tab active" onclick="switchTab('dashboard')">üè† Dashboard</div>
                    <div class="tab" onclick="switchTab('items')">üì¶ Items</div>
                    <div class="tab" onclick="switchTab('expenses')">üí∞ Expenses</div>
                    <div class="tab" onclick="switchTab('products')">üõçÔ∏è Products</div>
                    <div class="tab" onclick="switchTab('sales')">üìà Sales</div>
                    <div class="tab" onclick="switchTab('profit')">üíµ Profit</div>
                    <div class="tab" onclick="switchTab('labor')">üë∑ Labor</div>
                    <div class="tab" onclick="switchTab('inventory')">üìä Inventory</div>
                    <div class="tab" onclick="switchTab('reports')">üìã Reports</div>
                    <div class="tab" onclick="switchTab('settings')">‚öôÔ∏è Settings</div>
                `;
                // Show first tab
                document.getElementById('dashboard-tab').classList.add('active');
            } else {
                // User sees limited tabs
                tabsContainer.innerHTML = `
                    <div class="tab active" onclick="switchTab('dashboard')">üè† Dashboard</div>
                    <div class="tab" onclick="switchTab('products')">üõçÔ∏è Products</div>
                    <div class="tab" onclick="switchTab('sales')">üìà Sales</div>
                    <div class="tab" onclick="switchTab('earnings')">üí∞ Earnings</div>
                    <div class="tab" onclick="switchTab('settings')">‚öôÔ∏è Settings</div>
                `;
                // Show first tab
                document.getElementById('dashboard-tab').classList.add('active');
            }
        }

        function loadFirebaseConfig() {
            const config = localStorage.getItem('firebaseConfig');
            if (config) {
                try {
                    initializeFirebase(JSON.parse(config));
                } catch (e) {
                    console.error('Firebase init error:', e);
                    showConfigBanner(false);
                }
            } else {
                showConfigBanner(false);
            }
        }
        
        function initializeFirebase(config) {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(config);
                }
                db = firebase.firestore();
                firebaseInitialized = true;
                showConfigBanner(true);
                updateSyncStatus('Connected');
                
                if (currentUser) {
                    setupRealtimeSync();
                }
            } catch (e) {
                console.error('Firebase error:', e);
                showConfigBanner(false);
                updateSyncStatus('Error');
            }
        }
        
        function saveFirebaseConfig() {
            const config = {
                apiKey: document.getElementById('config-apiKey').value,
                authDomain: document.getElementById('config-authDomain').value,
                projectId: document.getElementById('config-projectId').value,
                storageBucket: document.getElementById('config-storageBucket').value,
                messagingSenderId: document.getElementById('config-messagingSenderId').value,
                appId: document.getElementById('config-appId').value
            };
            
            if (!config.apiKey || !config.projectId) {
                alert('Fill API Key and Project ID');
                return;
            }
            
            localStorage.setItem('firebaseConfig', JSON.stringify(config));
            closeSetupModal();
            initializeFirebase(config);
            alert('‚úÖ Connected!');
        }
        
        function clearFirebaseConfig() {
            if (confirm('Disconnect from Firebase?')) {
                if (unsubscribeItems) unsubscribeItems();
                if (unsubscribeProducts) unsubscribeProducts();
                if (unsubscribeSales) unsubscribeSales();
                if (unsubscribeExpenses) unsubscribeExpenses();
                
                localStorage.removeItem('firebaseConfig');
                firebaseInitialized = false;
                db = null;
                showConfigBanner(false);
                updateSyncStatus('Local');
            }
        }
        
        function testConnection() {
            if (!firebaseInitialized) {
                alert('Firebase not configured');
                return;
            }
            
            updateSyncStatus('Testing...');
            db.collection('_test').doc('connection').set({
                test: true,
                timestamp: new Date(),
                user: currentUser?.username || 'guest'
            }).then(() => {
                alert('‚úÖ Connected successfully!');
                updateSyncStatus('Connected');
            }).catch((error) => {
                alert('‚ùå Connection failed: ' + error.message);
                updateSyncStatus('Error');
            });
        }
        
        function setupRealtimeSync() {
            if (!firebaseInitialized || !currentUser) return;
            
            console.log('Setting up Firebase sync...');
            
            if (unsubscribeItems) unsubscribeItems();
            if (unsubscribeProducts) unsubscribeProducts();
            if (unsubscribeSales) unsubscribeSales();
            if (unsubscribeExpenses) unsubscribeExpenses();
            
            unsubscribeItems = db.collection('items').onSnapshot((snapshot) => {
                items = snapshot.docs.map(doc => ({...doc.data(), id: doc.data().id || parseInt(doc.id)}));
                console.log('Items synced:', items.length);
                saveLocal();
                renderItems();
                updateInventory();
                updateSKUFields();
            }, (error) => console.error('Items sync error:', error));
            
            unsubscribeProducts = db.collection('products').onSnapshot((snapshot) => {
                products = snapshot.docs.map(doc => ({...doc.data(), id: doc.data().id || parseInt(doc.id)}));
                console.log('Products synced:', products.length);
                saveLocal();
                renderProducts();
                updateAllDropdowns();
            }, (error) => console.error('Products sync error:', error));
            
            unsubscribeSales = db.collection('sales').onSnapshot((snapshot) => {
                sales = snapshot.docs.map(doc => ({...doc.data(), id: doc.data().id || parseInt(doc.id)}));
                console.log('Sales synced:', sales.length);
                saveLocal();
                renderSales();
                calculateEarnings();
                updateDashboard();
                calculateProfit();
                calculateLabor();
            }, (error) => console.error('Sales sync error:', error));
            
            unsubscribeExpenses = db.collection('expenses').onSnapshot((snapshot) => {
                expenses = snapshot.docs.map(doc => ({...doc.data(), id: doc.data().id || parseInt(doc.id)}));
                console.log('Expenses synced:', expenses.length);
                saveLocal();
                renderExpenses();
                updateInventory();
            }, (error) => console.error('Expenses sync error:', error));
            
            updateSyncStatus('Synced');
        }
        
        function saveToFirebase(collection, data) {
            if (!firebaseInitialized) {
                console.log('Firebase not initialized, saving locally only');
                saveLocal();
                return;
            }
            
            const docId = collection === 'users' ? data.username : data.id.toString();
            db.collection(collection).doc(docId).set(data)
                .then(() => console.log(`Saved to Firebase: ${collection}/${docId}`))
                .catch((e) => console.error('Firebase save error:', e));
        }
        
        function showConfigBanner(isConfigured) {
            const banner = document.getElementById('config-banner');
            if (isConfigured) {
                banner.className = 'config-banner success';
                banner.innerHTML = '‚úÖ Firebase Connected - Data syncing across devices';
            } else {
                banner.className = 'config-banner';
                banner.innerHTML = '‚ö†Ô∏è Firebase not configured. Data stored locally only. <a onclick="openSetupModal()">Setup cloud sync</a>';
            }
        }
        
        function updateSyncStatus(status) {
            document.getElementById('sync-status-text').textContent = status;
            const s = document.getElementById('settings-sync-status');
            if (s) {
                if (status === 'Connected' || status === 'Synced') {
                    s.textContent = '‚úÖ Connected and syncing across all devices';
                } else if (status === 'Local') {
                    s.textContent = 'üíæ Local storage only (not syncing)';
                } else {
                    s.textContent = status;
                }
            }
        }
        
        function openSetupModal() {
            document.getElementById('setup-modal').classList.add('active');
        }
        
        function closeSetupModal() {
            document.getElementById('setup-modal').classList.remove('active');
        }

        function checkSession() {
            const session = JSON.parse(sessionStorage.getItem('currentUser') || 'null');
            if (session) {
                currentUser = session;
                showApp();
            } else {
                showHome();
            }
        }
        
        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            users = initializeDefaultUsers();
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = {username: user.username, role: user.role, loginTime: new Date().toISOString()};
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                showApp();
                document.getElementById('login-form').reset();
                document.getElementById('login-error').innerHTML = '';
            } else {
                showError('Invalid username or password. Try: admin/admin123 or user/user123');
            }
        }
        
        function handleLogout() {
            if (confirm('Logout?')) {
                if (unsubscribeItems) unsubscribeItems();
                if (unsubscribeProducts) unsubscribeProducts();
                if (unsubscribeSales) unsubscribeSales();
                if (unsubscribeExpenses) unsubscribeExpenses();
                
                sessionStorage.removeItem('currentUser');
                currentUser = null;
                showHome();
            }
        }
        
        function changePassword(event) {
            event.preventDefault();
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            
            const userIndex = users.findIndex(u => u.username === currentUser.username);
            if (users[userIndex].password !== currentPassword) {
                alert('Wrong current password!');
                return;
            }
            
            users[userIndex].password = newPassword;
            saveUsers();
            saveToFirebase('users', users[userIndex]);
            document.getElementById('change-password-form').reset();
            alert('Password changed successfully!');
        }
        
        function addUser(event) {
            event.preventDefault();
            const username = document.getElementById('new-username').value;
            const password = document.getElementById('new-user-password').value;
            const role = document.getElementById('new-user-role').value;
            
            if (users.find(u => u.username === username)) {
                alert('Username already exists!');
                return;
            }
            
            const newUser = {username, password, role, createdAt: new Date().toISOString()};
            users.push(newUser);
            saveUsers();
            saveToFirebase('users', newUser);
            renderUsersList();
            document.getElementById('add-user-form').reset();
            alert('User added successfully!');
        }
        
        function deleteUser(username) {
            if (username === 'admin' || username === currentUser.username) {
                alert('Cannot delete this user!');
                return;
            }
            
            if (confirm('Delete user: ' + username + '?')) {
                users = users.filter(u => u.username !== username);
                saveUsers();
                if (firebaseInitialized) {
                    db.collection('users').doc(username).delete();
                }
                renderUsersList();
            }
        }
        
        function renderUsersList() {
            const container = document.getElementById('users-list');
            if (!container) return;
            
            container.innerHTML = `<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;"><thead><tr><th style="padding:12px;text-align:left;background:#f8f9fa;">Username</th><th style="padding:12px;text-align:left;background:#f8f9fa;">Role</th><th style="padding:12px;text-align:left;background:#f8f9fa;">Actions</th></tr></thead><tbody>${users.map(user => `<tr><td style="padding:12px;">${user.username}</td><td style="padding:12px;"><span class="user-role-badge">${user.role}</span></td><td style="padding:12px;">${user.username !== 'admin' && user.username !== currentUser.username ? `<button class="btn-danger" onclick="deleteUser('${user.username}')" style="padding:5px 15px;font-size:14px;">Delete</button>` : 'Protected'}</td></tr>`).join('')}</tbody></table></div>`;
        }
        
        function saveUsers() {
            localStorage.setItem('users', JSON.stringify(users));
        }
        
        function showError(message) {
            document.getElementById('login-error').innerHTML = `<div class="error-message">${message}</div>`;
        }
        
        function togglePassword() {
            const input = document.getElementById('login-password');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function loadLocalData() {
            items = JSON.parse(localStorage.getItem('items') || '[]');
            products = JSON.parse(localStorage.getItem('products') || '[]');
            sales = JSON.parse(localStorage.getItem('sales') || '[]');
            expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
            
            console.log('Loaded from localStorage:', {items: items.length, products: products.length, sales: sales.length, expenses: expenses.length});
        }
        
        function saveLocal() {
            localStorage.setItem('items', JSON.stringify(items));
            localStorage.setItem('products', JSON.stringify(products));
            localStorage.setItem('sales', JSON.stringify(sales));
            localStorage.setItem('expenses', JSON.stringify(expenses));
        }

        function generateItemSKU() {
            const prefix = 'ITM';
            const nums = items.map(i => i.sku).filter(sku => sku && sku.startsWith(prefix)).map(sku => parseInt(sku.replace(prefix, ''))).filter(num => !isNaN(num));
            const nextNum = nums.length > 0 ? Math.max(...nums) + 1 : 1;
            return `${prefix}${String(nextNum).padStart(4, '0')}`;
        }
        
        function generateProductSKU() {
            const prefix = 'PRD';
            const nums = products.map(p => p.sku).filter(sku => sku && sku.startsWith(prefix)).map(sku => parseInt(sku.replace(prefix, ''))).filter(num => !isNaN(num));
            const nextNum = nums.length > 0 ? Math.max(...nums) + 1 : 1;
            return `${prefix}${String(nextNum).padStart(4, '0')}`;
        }
        
        function updateSKUFields() {
            const itemSKU = document.getElementById('item-sku');
            if (itemSKU) itemSKU.value = generateItemSKU();
            
            const productSKU = document.getElementById('product-sku');
            if (productSKU) productSKU.value = generateProductSKU();
        }

        // ITEMS
        function addItem(event) {
            event.preventDefault();
            if (currentUser.role !== 'admin') {
                alert('Admin only!');
                return;
            }
            
            const item = {
                id: Date.now(),
                name: document.getElementById('item-name').value,
                price: parseFloat(document.getElementById('item-price').value),
                unit: document.getElementById('item-unit').value,
                category: document.getElementById('item-category').value || 'Uncategorized',
                sku: generateItemSKU(),
                quantity: parseFloat(document.getElementById('item-quantity').value) || 0,
                specifications: document.getElementById('item-specs').value,
                createdBy: currentUser.username,
                createdAt: new Date().toISOString()
            };
            
            items.push(item);
            saveLocal();
            saveToFirebase('items', item);
            renderItems();
            updateInventory();
            document.getElementById('item-form').reset();
            updateSKUFields();
            alert('Item added: ' + item.sku);
        }
        
        function renderItems() {
            const container = document.getElementById('items-list');
            if (!container) return;
            
            if (items.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No items yet</h3><p>Add items to get started</p></div>';
                return;
            }
            
            container.innerHTML = items.map(item => `<div class="item-card"><div class="item-header"><div><div class="item-name">${item.name} (${item.sku})</div><div style="color:#6c757d;font-size:14px;margin-top:5px;">${item.category} ‚Ä¢ ${item.unit} ‚Ä¢ Qty: ${item.quantity}</div>${item.specifications ? `<div style="color:#6c757d;font-size:13px;margin-top:5px;">${item.specifications}</div>` : ''}</div><div class="item-price">‚Ç±${item.price.toFixed(2)}</div></div>${currentUser.role === 'admin' ? `<div class="item-actions" style="margin-top:10px;"><button class="btn-danger" onclick="deleteItem(${item.id})">Delete</button></div>` : ''}</div>`).join('');
        }
        
        function deleteItem(id) {
            if (confirm('Delete this item?')) {
                items = items.filter(i => i.id !== id);
                saveLocal();
                if (firebaseInitialized) {
                    db.collection('items').doc(id.toString()).delete();
                }
                renderItems();
                updateSKUFields();
            }
        }
        
        function filterItems() {
            const search = document.getElementById('item-search')?.value.toLowerCase();
            if (!search) {
                renderItems();
                return;
            }
            
            const filtered = items.filter(item => item.name.toLowerCase().includes(search) || item.category.toLowerCase().includes(search) || (item.sku && item.sku.toLowerCase().includes(search)));
            const container = document.getElementById('items-list');
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>Not found</h3></div>';
                return;
            }
            
            container.innerHTML = filtered.map(item => `<div class="item-card"><div class="item-header"><div><div class="item-name">${item.name} (${item.sku})</div><div style="color:#6c757d;font-size:14px;">${item.category} ‚Ä¢ ${item.unit}</div></div><div class="item-price">‚Ç±${item.price.toFixed(2)}</div></div>${currentUser.role === 'admin' ? `<div class="item-actions" style="margin-top:10px;"><button class="btn-danger" onclick="deleteItem(${item.id})">Delete</button></div>` : ''}</div>`).join('');
        }

        // EXPENSES
        function addExpense(event) {
            event.preventDefault();
            if (currentUser.role !== 'admin') {
                alert('Admin only!');
                return;
            }
            
            const itemId = parseInt(document.getElementById('expense-item').value);
            const item = items.find(i => i.id === itemId);
            if (!item) {
                alert('Please select a valid item');
                return;
            }
            
            const quantity = parseFloat(document.getElementById('expense-quantity').value);
            const cost = parseFloat(document.getElementById('expense-cost').value);
            
            const expense = {
                id: Date.now(),
                date: document.getElementById('expense-date').value,
                itemId: itemId,
                itemName: item.name,
                itemUnit: item.unit,
                quantity: quantity,
                cost: cost,
                costPerUnit: cost / quantity,
                supplier: document.getElementById('expense-supplier').value,
                notes: document.getElementById('expense-notes').value,
                createdAt: new Date().toISOString()
            };
            
            expenses.push(expense);
            saveLocal();
            saveToFirebase('expenses', expense);
            renderExpenses();
            updateInventory();
            document.getElementById('expense-form').reset();
            document.getElementById('expense-date').valueAsDate = new Date();
            alert('Expense recorded!');
        }
        
        function renderExpenses() {
            const container = document.getElementById('expenses-list');
            if (!container) return;
            
            const filter = document.getElementById('expense-filter')?.value || 'all';
            const filtered = filterByPeriod(expenses, filter);
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No expenses recorded</h3></div>';
                return;
            }
            
            const totalExpenses = filtered.reduce((sum, exp) => sum + exp.cost, 0);
            container.innerHTML = `<div class="info-box"><h4>Total Expenses (${filter}): ‚Ç±${totalExpenses.toFixed(2)}</h4></div>` + filtered.reverse().map(expense => `<div class="expense-card"><div class="item-header"><div><div class="item-name">${expense.itemName}</div><div style="color:#6c757d;font-size:14px;margin-top:5px;">${expense.quantity} ${expense.itemUnit} @ ‚Ç±${expense.costPerUnit.toFixed(2)}/${expense.itemUnit}${expense.supplier ? ` ‚Ä¢ Supplier: ${expense.supplier}` : ''}</div><span class="date-badge">${new Date(expense.date).toLocaleDateString()}</span></div><div class="item-price">‚Ç±${expense.cost.toFixed(2)}</div></div>${expense.notes ? `<div style="margin-top:10px;color:#6c757d;font-size:14px;">üìù ${expense.notes}</div>` : ''}<div class="item-actions"><button class="btn-danger" onclick="deleteExpense(${expense.id})">Delete</button></div></div>`).join('');
        }
        
        function deleteExpense(id) {
            if (confirm('Delete this expense?')) {
                expenses = expenses.filter(e => e.id !== id);
                saveLocal();
                if (firebaseInitialized) {
                    db.collection('expenses').doc(id.toString()).delete();
                }
                renderExpenses();
                updateInventory();
            }
        }
        
        function filterExpenses() {
            renderExpenses();
        }

        // PRODUCTS
        function addIngredientRow() {
            const container = document.getElementById('ingredients-container');
            const rowId = Date.now();
            const row = document.createElement('div');
            row.className = 'ingredient-row';
            row.id = 'ingredient-' + rowId;
            row.innerHTML = `<div><label>Item</label><select class="ingredient-item" required><option value="">Select...</option>${items.map(item => `<option value="${item.id}">${item.name} (‚Ç±${item.price}/${item.unit})</option>`).join('')}</select></div><div><label>Quantity</label><input type="number" class="ingredient-quantity" step="0.01" required placeholder="0"></div><button type="button" class="btn-danger" onclick="removeIngredientRow(${rowId})">Remove</button>`;
            container.appendChild(row);
        }
        
        function removeIngredientRow(rowId) {
            document.getElementById('ingredient-' + rowId).remove();
        }
        
        function addProduct(event) {
            event.preventDefault();
            
            const ingredientRows = document.querySelectorAll('.ingredient-row');
            const ingredients = [];
            let materialsCost = 0;
            
            ingredientRows.forEach(row => {
                const itemId = parseInt(row.querySelector('.ingredient-item').value);
                const quantity = parseFloat(row.querySelector('.ingredient-quantity').value);
                const item = items.find(i => i.id === itemId);
                
                if (item && quantity > 0) {
                    const cost = item.price * quantity;
                    materialsCost += cost;
                    ingredients.push({itemId, itemName: item.name, quantity, unit: item.unit, pricePerUnit: item.price, totalCost: cost});
                }
            });
            
            if (ingredients.length === 0) {
                alert('Add at least one material!');
                return;
            }
            
            const laborCost = parseFloat(document.getElementById('product-labor').value) || 0;
            const markupPercent = parseFloat(document.getElementById('product-markup').value) || 0;
            const totalCost = materialsCost + laborCost;
            const sellingPrice = totalCost * (1 + markupPercent / 100);
            
            const product = {
                id: Date.now(),
                name: document.getElementById('product-name').value,
                sku: generateProductSKU(),
                description: document.getElementById('product-description').value,
                ingredients,
                materialsCost,
                laborCost,
                totalCost,
                markupPercent,
                sellingPrice,
                createdBy: currentUser.username,
                createdAt: new Date().toISOString()
            };
            
            products.push(product);
            saveLocal();
            saveToFirebase('products', product);
            renderProducts();
            updateAllDropdowns();
            document.getElementById('product-form').reset();
            document.getElementById('ingredients-container').innerHTML = '';
            updateSKUFields();
            alert(`Product created! Selling price: ‚Ç±${sellingPrice.toFixed(2)}`);
        }
        
        function renderProducts() {
            const container = document.getElementById('products-list');
            if (!container) return;
            
            if (products.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No products yet</h3><p>Create products using items</p></div>';
                return;
            }
            
            container.innerHTML = products.map(product => `<div class="product-card"><div class="item-header"><div><div class="item-name">${product.name} (${product.sku})</div>${product.description ? `<div style="color:#6c757d;font-size:14px;">${product.description}</div>` : ''}<div style="margin-top:5px;"><span style="font-size:12px;color:#6c757d;">By: ${product.createdBy}</span></div></div><div class="item-price">‚Ç±${product.sellingPrice.toFixed(2)}</div></div><div class="calculation-box"><h4 style="margin-bottom:15px;">Cost Breakdown</h4>${product.ingredients.map(ing => `<div class="calculation-row"><span>${ing.itemName} (${ing.quantity} ${ing.unit})</span><span>‚Ç±${ing.totalCost.toFixed(2)}</span></div>`).join('')}<div class="calculation-row"><span><strong>Materials Total</strong></span><span><strong>‚Ç±${product.materialsCost.toFixed(2)}</strong></span></div><div class="calculation-row"><span>Labor Cost</span><span>‚Ç±${product.laborCost.toFixed(2)}</span></div><div class="calculation-row total"><span>Selling Price</span><span>‚Ç±${product.sellingPrice.toFixed(2)}</span></div></div><div class="item-actions" style="margin-top:10px;"><button class="btn-danger" onclick="deleteProduct(${product.id})">Delete</button></div></div>`).join('');
        }
        
        function deleteProduct(id) {
            if (confirm('Delete this product?')) {
                products = products.filter(p => p.id !== id);
                saveLocal();
                if (firebaseInitialized) {
                    db.collection('products').doc(id.toString()).delete();
                }
                renderProducts();
                updateAllDropdowns();
            }
        }

        // SALES
        function updateSalePrice() {
            const productId = parseInt(document.getElementById('sale-product').value);
            const product = products.find(p => p.id === productId);
            if (product) {
                document.getElementById('sale-price').value = product.sellingPrice.toFixed(2);
            }
        }
        
        function recordSale(event) {
            event.preventDefault();
            
            const productId = parseInt(document.getElementById('sale-product').value);
            const product = products.find(p => p.id === productId);
            
            if (!product) {
                alert('Select a product');
                return;
            }
            
            const quantity = parseInt(document.getElementById('sale-quantity').value);
            const sellingPrice = parseFloat(document.getElementById('sale-price').value);
            const totalRevenue = sellingPrice * quantity;
            
            let userEarnings = 0;
            if (product.createdBy === currentUser.username) {
                userEarnings = product.laborCost * quantity;
            } else {
                userEarnings = totalRevenue * 0.10;
            }
            
            const totalCost = product.totalCost * quantity;
            const totalProfit = totalRevenue - totalCost;
            
            const sale = {
                id: Date.now(),
                date: document.getElementById('sale-date').value,
                productId,
                productName: product.name,
                productCreator: product.createdBy,
                quantity,
                sellingPrice,
                totalRevenue,
                costPerUnit: product.totalCost,
                totalCost,
                profit: totalProfit,
                laborCost: product.laborCost * quantity,
                soldBy: currentUser.username,
                userEarnings,
                earningsType: product.createdBy === currentUser.username ? 'labor' : 'commission',
                customer: document.getElementById('sale-customer').value,
                payment: document.getElementById('sale-payment').value,
                createdAt: new Date().toISOString()
            };
            
            sales.push(sale);
            saveLocal();
            saveToFirebase('sales', sale);
            renderSales();
            calculateEarnings();
            updateDashboard();
            calculateProfit();
            calculateLabor();
            document.getElementById('sale-form').reset();
            document.getElementById('sale-date').valueAsDate = new Date();
            alert(`Sale recorded! You earned: ‚Ç±${userEarnings.toFixed(2)}`);
        }
        
        function renderSales() {
            const container = document.getElementById('sales-list');
            if (!container) return;
            
            const filter = document.getElementById('sales-filter')?.value || 'all';
            const filtered = filterByPeriod(sales, filter);
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No sales yet</h3></div>';
                return;
            }
            
            const totalRevenue = filtered.reduce((sum, sale) => sum + sale.totalRevenue, 0);
            const totalProfit = filtered.reduce((sum, sale) => sum + sale.profit, 0);
            
            container.innerHTML = `<div class="info-box"><h4>Total Revenue (${filter}): ‚Ç±${totalRevenue.toFixed(2)} | Total Profit: ‚Ç±${totalProfit.toFixed(2)}</h4></div>` + filtered.reverse().map(sale => `<div class="sale-card"><div class="item-header"><div><div class="item-name">${sale.productName} x${sale.quantity}</div><div style="color:#6c757d;font-size:14px;margin-top:5px;">@ ‚Ç±${sale.sellingPrice.toFixed(2)} each${sale.customer ? ' ‚Ä¢ ' + sale.customer : ''}${sale.payment ? ' ‚Ä¢ ' + sale.payment : ''}</div><div style="margin-top:5px;"><span style="font-size:12px;color:#6c757d;">Sold by: ${sale.soldBy}</span><span class="earnings-badge ${sale.earningsType === 'labor' ? 'own' : 'commission'}">${sale.earningsType === 'labor' ? 'Own Product' : '10% Commission'}</span></div></div><div><div class="item-price">‚Ç±${sale.totalRevenue.toFixed(2)}</div><div style="text-align:right;font-size:14px;color:#28a745;margin-top:5px;">Earned: ‚Ç±${sale.userEarnings.toFixed(2)}</div></div></div></div>`).join('');
        }
        
        function filterSales() {
            renderSales();
        }

        // EARNINGS
        function calculateEarnings() {
            const filter = document.getElementById('earnings-filter')?.value || 'all';
            const mySales = filterByPeriod(sales.filter(s => s.soldBy === currentUser.username), filter);
            
            const totalEarnings = mySales.reduce((sum, s) => sum + s.userEarnings, 0);
            const laborEarnings = mySales.filter(s => s.earningsType === 'labor').reduce((sum, s) => sum + s.userEarnings, 0);
            const commissionEarnings = mySales.filter(s => s.earningsType === 'commission').reduce((sum, s) => sum + s.userEarnings, 0);
            const totalSales = mySales.length;
            
            const statsContainer = document.getElementById('earnings-stats');
            if (statsContainer) {
                statsContainer.innerHTML = `<div class="stat-card success"><div class="stat-value">‚Ç±${totalEarnings.toFixed(2)}</div><div class="stat-label">Total Earnings</div></div><div class="stat-card info"><div class="stat-value">‚Ç±${laborEarnings.toFixed(2)}</div><div class="stat-label">From Labor</div></div><div class="stat-card warning"><div class="stat-value">‚Ç±${commissionEarnings.toFixed(2)}</div><div class="stat-label">From Commission</div></div><div class="stat-card"><div class="stat-value">${totalSales}</div><div class="stat-label">Total Sales</div></div>`;
            }
            
            const detailsContainer = document.getElementById('earnings-details');
            if (detailsContainer) {
                if (mySales.length === 0) {
                    detailsContainer.innerHTML = '<div class="empty-state"><h3>No sales in this period</h3></div>';
                } else {
                    detailsContainer.innerHTML = mySales.reverse().map(sale => `<div class="sale-card"><div class="item-header"><div><div class="item-name">${sale.productName} x${sale.quantity}</div><div style="color:#6c757d;font-size:14px;margin-top:5px;">${new Date(sale.date).toLocaleDateString()}<span class="earnings-badge ${sale.earningsType === 'labor' ? 'own' : 'commission'}">${sale.earningsType === 'labor' ? 'Your Product' : '10% Commission'}</span></div></div><div class="item-price">‚Ç±${sale.userEarnings.toFixed(2)}</div></div></div>`).join('');
                }
            }
        }

        // PROFIT
        function calculateProfit() {
            const filter = document.getElementById('profit-filter')?.value || 'all';
            const filteredSales = filterByPeriod(sales, filter);
            const filteredExpenses = filterByPeriod(expenses, filter);
            
            const totalRevenue = filteredSales.reduce((sum, sale) => sum + sale.totalRevenue, 0);
            const totalCost = filteredSales.reduce((sum, sale) => sum + sale.totalCost, 0);
            const totalExpenses = filteredExpenses.reduce((sum, exp) => sum + exp.cost, 0);
            const grossProfit = totalRevenue - totalCost;
            const netProfit = totalRevenue - totalCost;
            const profitMargin = totalRevenue > 0 ? (grossProfit / totalRevenue * 100) : 0;
            
            const summaryContainer = document.getElementById('profit-summary');
            if (summaryContainer) {
                summaryContainer.innerHTML = `<div class="stats-grid"><div class="stat-card success"><div class="stat-value">‚Ç±${totalRevenue.toFixed(2)}</div><div class="stat-label">Total Revenue</div></div><div class="stat-card danger"><div class="stat-value">‚Ç±${totalCost.toFixed(2)}</div><div class="stat-label">Product Costs</div></div><div class="stat-card warning"><div class="stat-value">‚Ç±${totalExpenses.toFixed(2)}</div><div class="stat-label">Total Expenses</div></div><div class="stat-card ${grossProfit >= 0 ? 'success' : 'danger'}"><div class="stat-value">‚Ç±${grossProfit.toFixed(2)}</div><div class="stat-label">Gross Profit</div></div></div><div class="profit-card"><h3>Net Profit (${filter})</h3><div class="profit-value">‚Ç±${netProfit.toFixed(2)}</div><div style="font-size:1.2em;">Profit Margin: ${profitMargin.toFixed(2)}% | Total Sales: ${filteredSales.length}</div></div>`;
            }
            
            const productBreakdown = {};
            filteredSales.forEach(sale => {
                if (!productBreakdown[sale.productName]) {
                    productBreakdown[sale.productName] = {quantity: 0, revenue: 0, cost: 0, profit: 0};
                }
                productBreakdown[sale.productName].quantity += sale.quantity;
                productBreakdown[sale.productName].revenue += sale.totalRevenue;
                productBreakdown[sale.productName].cost += sale.totalCost;
                productBreakdown[sale.productName].profit += sale.profit;
            });
            
            const detailsContainer = document.getElementById('profit-details');
            if (detailsContainer) {
                detailsContainer.innerHTML = `<h3 style="margin-top:30px;">Profit by Product</h3><div class="table-container"><table><thead><tr><th>Product</th><th>Units Sold</th><th>Revenue</th><th>Cost</th><th>Profit</th><th>Margin</th></tr></thead><tbody>${Object.entries(productBreakdown).map(([name, data]) => `<tr><td><strong>${name}</strong></td><td>${data.quantity}</td><td>‚Ç±${data.revenue.toFixed(2)}</td><td>‚Ç±${data.cost.toFixed(2)}</td><td style="color:${data.profit >= 0 ? '#28a745' : '#dc3545'}"><strong>‚Ç±${data.profit.toFixed(2)}</strong></td><td>${((data.profit / data.revenue) * 100).toFixed(1)}%</td></tr>`).join('')}</tbody></table></div>`;
            }
        }

        // LABOR
        function calculateLabor() {
            const filter = document.getElementById('labor-filter')?.value || 'all';
            const filteredSales = filterByPeriod(sales, filter);
            
            const totalLabor = filteredSales.reduce((sum, sale) => sum + sale.laborCost, 0);
            const totalSales = filteredSales.length;
            const averageLabor = totalSales > 0 ? totalLabor / totalSales : 0;
            
            const summaryContainer = document.getElementById('labor-summary');
            if (summaryContainer) {
                summaryContainer.innerHTML = `<div class="stats-grid"><div class="stat-card info"><div class="stat-value">‚Ç±${totalLabor.toFixed(2)}</div><div class="stat-label">Total Labor Earned</div></div><div class="stat-card"><div class="stat-value">${totalSales}</div><div class="stat-label">Products Sold</div></div><div class="stat-card warning"><div class="stat-value">‚Ç±${averageLabor.toFixed(2)}</div><div class="stat-label">Average Labor per Sale</div></div></div>`;
            }
            
            const laborBreakdown = {};
            filteredSales.forEach(sale => {
                if (!laborBreakdown[sale.productName]) {
                    laborBreakdown[sale.productName] = {count: 0, totalLabor: 0};
                }
                laborBreakdown[sale.productName].count += sale.quantity;
                laborBreakdown[sale.productName].totalLabor += sale.laborCost;
            });
            
            const detailsContainer = document.getElementById('labor-details');
            if (detailsContainer) {
                detailsContainer.innerHTML = `<h3 style="margin-top:30px;">Labor by Product</h3><div class="table-container"><table><thead><tr><th>Product</th><th>Units Produced</th><th>Total Labor</th><th>Labor per Unit</th></tr></thead><tbody>${Object.entries(laborBreakdown).map(([name, data]) => `<tr><td><strong>${name}</strong></td><td>${data.count}</td><td>‚Ç±${data.totalLabor.toFixed(2)}</td><td>‚Ç±${(data.totalLabor / data.count).toFixed(2)}</td></tr>`).join('')}</tbody></table></div>`;
            }
        }

        // INVENTORY
        function updateInventory() {
            const inventory = {};
            
            expenses.forEach(expense => {
                if (!inventory[expense.itemId]) {
                    const item = items.find(i => i.id === expense.itemId);
                    inventory[expense.itemId] = {name: expense.itemName, unit: expense.itemUnit, purchased: 0, used: 0, remaining: 0, totalCost: 0, lowStock: item?.lowStock || 0};
                }
                inventory[expense.itemId].purchased += expense.quantity;
                inventory[expense.itemId].totalCost += expense.cost;
            });
            
            sales.forEach(sale => {
                const product = products.find(p => p.id === sale.productId);
                if (product) {
                    product.ingredients.forEach(ing => {
                        if (inventory[ing.itemId]) {
                            inventory[ing.itemId].used += ing.quantity * sale.quantity;
                        }
                    });
                }
            });
            
            Object.values(inventory).forEach(item => {
                item.remaining = item.purchased - item.used;
            });
            
            const container = document.getElementById('inventory-list');
            if (!container) return;
            
            if (Object.keys(inventory).length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No inventory data</h3><p>Record expenses to see inventory levels</p></div>';
                return;
            }
            
            container.innerHTML = Object.values(inventory).map(item => `<div class="item-card"><div class="item-header"><div><div class="item-name">${item.name}</div><div style="color:#6c757d;font-size:14px;margin-top:5px;">Purchased: ${item.purchased.toFixed(2)} ${item.unit} | Used: ${item.used.toFixed(2)} ${item.unit}</div><div class="stock-status ${item.remaining <= item.lowStock && item.lowStock > 0 ? 'stock-low' : ''}">${item.remaining <= item.lowStock && item.lowStock > 0 ? '‚ö†Ô∏è Low Stock Alert!' : ''}</div></div><div><div class="item-price">${item.remaining.toFixed(2)} ${item.unit}</div><div style="text-align:right;font-size:14px;color:#6c757d;margin-top:5px;">Value: ‚Ç±${item.totalCost.toFixed(2)}</div></div></div></div>`).join('');
        }

        // REPORTS
        function updateReports() {
            document.getElementById('report-total-items').textContent = items.length;
            document.getElementById('report-total-products').textContent = products.length;
            
            const totalExpenses = expenses.reduce((sum, exp) => sum + exp.cost, 0);
            document.getElementById('report-total-expenses').textContent = '‚Ç±' + totalExpenses.toFixed(2);
            
            const totalSales = sales.reduce((sum, sale) => sum + sale.totalRevenue, 0);
            document.getElementById('report-total-sales').textContent = '‚Ç±' + totalSales.toFixed(2);
        }

        // DASHBOARD
        function updateDashboard() {
            const mySales = sales.filter(s => s.soldBy === currentUser.username);
            const myEarnings = mySales.reduce((sum, s) => sum + s.userEarnings, 0);
            const totalSales = mySales.length;
            const myProducts = products.filter(p => p.createdBy === currentUser.username).length;
            
            const statsContainer = document.getElementById('dashboard-stats');
            if (statsContainer) {
                statsContainer.innerHTML = `<div class="stat-card success"><div class="stat-value">‚Ç±${myEarnings.toFixed(2)}</div><div class="stat-label">My Earnings</div></div><div class="stat-card info"><div class="stat-value">${totalSales}</div><div class="stat-label">My Sales</div></div><div class="stat-card"><div class="stat-value">${myProducts}</div><div class="stat-label">My Products</div></div><div class="stat-card warning"><div class="stat-value">${products.length}</div><div class="stat-label">Total Products</div></div>`;
            }
            
            const activityContainer = document.getElementById('recent-activity');
            if (activityContainer) {
                const recentSales = mySales.slice(-5).reverse();
                if (recentSales.length === 0) {
                    activityContainer.innerHTML = '<div class="empty-state"><h3>No recent activity</h3></div>';
                } else {
                    activityContainer.innerHTML = recentSales.map(sale => `<div class="sale-card"><div class="item-header"><div><div class="item-name">${sale.productName} x${sale.quantity}</div><div style="color:#6c757d;font-size:14px;">${new Date(sale.date).toLocaleDateString()}</div></div><div class="item-price">‚Ç±${sale.userEarnings.toFixed(2)}</div></div></div>`).join('');
                }
            }
        }

        // CATALOG
        function renderCatalog() {
            const container = document.getElementById('product-catalog-grid');
            if (!container) return;
            
            if (products.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No products available</h3></div>';
                return;
            }
            
            container.innerHTML = products.map(product => {
                const availableQty = items.reduce((total, item) => {
                    const ingredient = product.ingredients.find(ing => ing.itemId === item.id);
                    if (ingredient) {
                        const maxUnits = Math.floor(item.quantity / ingredient.quantity);
                        return total === null ? maxUnits : Math.min(total, maxUnits);
                    }
                    return total;
                }, null);
                
                const stockClass = availableQty <= 5 ? 'low' : '';
                
                return `<div class="product-catalog-card"><div class="product-catalog-name">${product.name}</div>${product.description ? `<div style="color:#6c757d;margin:10px 0;">${product.description}</div>` : ''}<div class="product-catalog-price">‚Ç±${product.sellingPrice.toFixed(2)}</div><div class="product-catalog-stock ${stockClass}">${availableQty !== null ? `${availableQty} available` : 'In Stock'}</div><div style="margin-top:15px;padding-top:15px;border-top:1px solid #dee2e6;"><div style="font-size:13px;color:#6c757d;"><strong>Materials:</strong><br>${product.ingredients.map(ing => `${ing.itemName} (${ing.quantity} ${ing.unit})`).join(', ')}</div></div></div>`;
            }).join('');
        }
        
        function filterCatalog() {
            const search = document.getElementById('catalog-search')?.value.toLowerCase();
            if (!search) {
                renderCatalog();
                return;
            }
            
            const filtered = products.filter(p => p.name.toLowerCase().includes(search) || (p.description && p.description.toLowerCase().includes(search)));
            const container = document.getElementById('product-catalog-grid');
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No products found</h3></div>';
                return;
            }
            
            container.innerHTML = filtered.map(product => `<div class="product-catalog-card"><div class="product-catalog-name">${product.name}</div>${product.description ? `<div style="color:#6c757d;margin:10px 0;">${product.description}</div>` : ''}<div class="product-catalog-price">‚Ç±${product.sellingPrice.toFixed(2)}</div></div>`).join('');
        }

        // UTILS
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            if (tabName === 'earnings') calculateEarnings();
            if (tabName === 'dashboard') updateDashboard();
            if (tabName === 'profit') calculateProfit();
            if (tabName === 'labor') calculateLabor();
            if (tabName === 'inventory') updateInventory();
            if (tabName === 'reports') updateReports();
        }
        
        function updateAllDropdowns() {
            const expenseSelect = document.getElementById('expense-item');
            if (expenseSelect) {
                expenseSelect.innerHTML = '<option value="">Choose an item...</option>' + items.map(item => `<option value="${item.id}">${item.name} (${item.unit})</option>`).join('');
            }
            
            const saleSelect = document.getElementById('sale-product');
            if (saleSelect) {
                saleSelect.innerHTML = '<option value="">Choose...</option>' + products.map(p => `<option value="${p.id}">${p.name} - ‚Ç±${p.sellingPrice.toFixed(2)}</option>`).join('');
            }
        }
        
        function filterByPeriod(data, period) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            return data.filter(item => {
                const itemDate = new Date(item.date);
                switch (period) {
                    case 'today':
                        return itemDate >= today;
                    case 'week':
                        const weekAgo = new Date(today);
                        weekAgo.setDate(weekAgo.getDate() - 7);
                        return itemDate >= weekAgo;
                    case 'month':
                        const monthAgo = new Date(today);
                        monthAgo.setMonth(monthAgo.getMonth() - 1);
                        return itemDate >= monthAgo;
                    default:
                        return true;
                }
            });
        }
        
        function exportData() {
            const data = {items, expenses, products, sales, exportDate: new Date().toISOString()};
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `business-data-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (confirm('This will replace all existing data. Continue?')) {
                        items = data.items || [];
                        expenses = data.expenses || [];
                        products = data.products || [];
                        sales = data.sales || [];
                        
                        saveLocal();
                        renderAll();
                        updateSKUFields();
                        calculateProfit();
                        calculateLabor();
                        updateInventory();
                        updateReports();
                        alert('Data imported successfully!');
                    }
                } catch (error) {
                    alert('Error importing data. Please check the file format.');
                }
            };
            reader.readAsText(file);
        }
        
        function renderAll() {
            renderItems();
            renderProducts();
            renderSales();
            renderExpenses();
            renderInventory();
            updateAllDropdowns();
        }
    </script>
</body>
</html>
